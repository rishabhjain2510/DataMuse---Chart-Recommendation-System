<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataMuse - Create a Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Funnel Display', sans-serif; 
        }
        .dark-gradient {
            min-height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #1a0d2e 0%, #2d1b47 25%, #5b2c6f 50%, #8b3a62 75%, #b83d50 100%);
        }
        .dark-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('{{ url_for("static", filename="images/DATAMUSE.png") }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.8;
            z-index: 0;
        }
        .content-overlay {
            position: relative;
            z-index: 1;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }
        .form-select {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23cb00ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            color: white;
            transition: all 0.3s ease;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .form-select:focus {
            border-color: rgba(203, 0, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(203, 0, 255, 0.1);
        }
        .form-select option {
            background: #1a0d2e;
            color: white;
        }
        .gradient-button {
            background: linear-gradient(135deg, #cb00ff 0%, #8b3a62 50%, #b83d50 100%);
            transition: all 0.3s ease;
        }
        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(203, 0, 255, 0.4);
        }
        .gradient-button:disabled {
            opacity: 0.5;
            transform: none;
            box-shadow: none;
        }
        .detected-type {
            height: 1rem;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(203, 0, 255, 0.3);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .placeholder-text {
            color: #8b3a62;
            font-size: 1.2rem;
            text-align: center;
            opacity: 0.7;
        }

    </style>
</head>
<body class="dark-gradient text-white min-h-screen">
    <!-- Navbar -->
    <nav class="content-overlay fixed top-0 left-0 right-0 z-10 p-6">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white tracking-tight" style="font-family: 'Funnel Display', sans-serif;">DATAMUSE</h1>
        </div>
    </nav>

    <div class="w-full max-w-full mx-auto content-overlay pt-24 px-6 pb-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 h-full">
            
            <!-- Left Side - Chart Display -->
            <div class="lg:col-span-3">
                <div class="glass-card rounded-3xl p-6 h-full">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-semibold text-white mb-2">Your Visualization</h2>
                    </div>
                    
                    <div class="chart-container">
                        {% if chart_url %}
                            <img src="{{ chart_url }}?v={{ range(1, 10000) | random }}" alt="Generated Chart" class="w-full h-auto rounded-lg">
                        {% else %}
                            <div class="placeholder-text">
                                <div class="text-center">
                                    <svg class="mx-auto h-16 w-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    <p>Select columns and chart type to generate your visualization</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Hidden div to pass chart URL to JavaScript -->
                    <div id="initial-chart-url" data-url="{% if chart_url %}{{ chart_url }}{% endif %}" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Right Side - Chart Controls -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-3xl p-6">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-semibold text-white mb-2">Chart Settings</h2>
                        <p class="text-gray-300 opacity-80 text-sm">Configure your visualization</p>
                    </div>

                    <form id="chartForm" class="space-y-4" autocomplete="off">
                        
                        <!-- Column Selectors -->
                        <div class="space-y-4">
                            <div>
                                <label for="col1" class="block text-sm font-medium text-purple-200 mb-2">Column 1 (X-Axis)</label>
                                <select id="col1" name="col1" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-sm rounded-xl" required autocomplete="off">
                                    <option value="">-- Select a Column --</option>
                                    {% for col in all_cols %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                                <p id="col1-type" class="text-xs text-purple-300 mt-1 detected-type"></p>
                            </div>
                            <div>
                                <label for="col2" class="block text-sm font-medium text-purple-200 mb-2">Column 2 (Y-Axis, Optional)</label>
                                <select id="col2" name="col2" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-sm rounded-xl" autocomplete="off">
                                    <option value="">-- None --</option>
                                     {% for col in all_cols %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                                <p id="col2-type" class="text-xs text-purple-300 mt-1 detected-type"></p>
                            </div>
                        </div>

                        <!-- Suggested Chart Types -->
                        <div>
                            <label for="chart_type" class="block text-sm font-medium text-purple-200 mb-2">Chart Type</label>
                            <select id="chart_type" name="chart_type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-sm rounded-xl" required>
                                <option value="" disabled selected>-- Select columns first --</option>
                            </select>
                        </div>
                        
                        <!-- Axis Rotation Selectors -->
                        <div id="rotation-selectors" class="space-y-4">
                            <div>
                                <label for="rotation" class="block text-sm font-medium text-purple-200 mb-2">X-Axis Rotation</label>
                                <select id="rotation" name="rotation" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-sm rounded-xl">
                                    <option value="0">0° (Horizontal)</option>
                                    <option value="45">45°</option>
                                    <option value="90">90° (Vertical)</option>
                                </select>
                            </div>
                             <div>
                                <label for="y_rotation" class="block text-sm font-medium text-purple-200 mb-2">Y-Axis Rotation</label>
                                <select id="y_rotation" name="y_rotation" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-sm rounded-xl">
                                    <option value="0">0° (Horizontal)</option>
                                    <option value="45">45°</option>
                                    <option value="90">90° (Vertical)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div>
                            <button type="button" id="submit-btn" class="w-full gradient-button py-3 px-4 rounded-xl text-sm font-semibold text-white shadow-lg disabled:opacity-50 transition-all duration-200" disabled>
                                Generate Chart
                            </button>
                        </div>
                        
                        <!-- Download Button -->
                        <div>
                            <button type="button" id="download-btn" class="w-full bg-gray-600 hover:bg-gray-700 py-3 px-4 rounded-xl text-sm font-semibold text-white shadow-lg disabled:opacity-50 transition-all duration-200" disabled>
                                Download Chart
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data for JS -->
    <div id="column-data" 
        data-numeric='{{ numeric_cols|tojson|safe }}' 
        data-categorical='{{ categorical_cols|tojson|safe }}' 
        data-datetime='{{ datetime_cols|tojson|safe }}'
        style="display: none;">
    </div>

    <script>
        // --- DATA SETUP ---
        const columnDataEl = document.getElementById('column-data');
        const numericCols = JSON.parse(columnDataEl.dataset.numeric);
        const categoricalCols = JSON.parse(columnDataEl.dataset.categorical);
        const datetimeCols = JSON.parse(columnDataEl.dataset.datetime);

        // --- ELEMENT SELECTORS ---
        const col1Select = document.getElementById('col1');
        const col2Select = document.getElementById('col2');
        const chartTypeSelect = document.getElementById('chart_type');
        const submitBtn = document.getElementById('submit-btn');
        const downloadBtn = document.getElementById('download-btn');
        const col1TypeEl = document.getElementById('col1-type');
        const col2TypeEl = document.getElementById('col2-type');
        let currentChartUrl = null;

        // --- HELPER FUNCTION ---
        function getColumnType(columnName) {
            if (!columnName) return null;
            if (numericCols.includes(columnName)) return 'Numeric';
            if (categoricalCols.includes(columnName)) return 'Categorical';
            if (datetimeCols.includes(columnName)) return 'Datetime';
            return 'Unknown';
        }

        // --- CORE LOGIC: Update suggestions based on selected columns ---
        function updateSuggestions() {
            const col1 = col1Select.value;
            const col2 = col2Select.value;
            const type1 = getColumnType(col1);
            const type2 = getColumnType(col2);

            // Update detected type display
            col1TypeEl.textContent = type1 ? `Detected as: ${type1}` : '';
            col2TypeEl.textContent = type2 ? `Detected as: ${type2}` : '';

            let suggestions = [];

            // Rule Implementation based on your logic
            if (col1 && !col2) { // Single Column Logic
                if (type1 === 'Numeric') {
                    suggestions = ["Histogram", "Box Plot (Single Column)"];
                } else if (type1 === 'Categorical') {
                    suggestions = ["Count Plot", "Pie Chart"];
                }
            } else if (col1 && col2 && col1 !== col2) { // Two Column Logic
                const types = [type1, type2].sort().join(',');
                if (types === 'Numeric,Numeric') {
                    suggestions = ["Scatter Plot"];
                } else if (types === 'Categorical,Numeric') {
                    suggestions = ["Bar Plot (by Value)", "Box Plot (by Category)"];
                } else if (types === 'Datetime,Numeric') {
                    suggestions = ["Line Plot (Time-Series)"];
                } else if (types === 'Categorical,Categorical') {
                    suggestions = ["Heatmap (Crosstab)"];
                }
            }
            
            // Add multi-column charts that don't depend on selection
            if(numericCols.length >= 2) {
                 if (!suggestions.includes("Correlation Heatmap")) {
                    suggestions.push("Correlation Heatmap");
                 }
            }

            // --- UI UPDATE ---
            chartTypeSelect.innerHTML = ''; // Clear old options
            if (suggestions.length > 0) {
                submitBtn.disabled = false;
                suggestions.forEach(chart => {
                    const option = document.createElement('option');
                    option.value = chart;
                    option.textContent = chart;
                    chartTypeSelect.appendChild(option);
                });
            } else {
                submitBtn.disabled = true;
                const option = document.createElement('option');
                option.textContent = col1 ? '-- No charts for this combination --' : '-- Select columns first --';
                option.disabled = true;
                option.selected = true;
                chartTypeSelect.appendChild(option);
            }
        }

        // --- AJAX CHART GENERATION ---
        async function generateChart() {
            const formData = {
                chart_type: chartTypeSelect.value,
                col1: col1Select.value,
                col2: col2Select.value,
                rotation: document.getElementById('rotation').value,
                y_rotation: document.getElementById('y_rotation').value
            };

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            try {
                const response = await fetch('/generate_chart_ajax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success && result.chart_url) {
                    // Update chart display
                    const chartContainer = document.querySelector('.chart-container');
                    currentChartUrl = result.chart_url;
                    chartContainer.innerHTML = `<img src="${result.chart_url}?v=${Date.now()}" alt="Generated Chart" class="w-full h-auto rounded-lg">`;
                    
                    // Enable download button
                    downloadBtn.disabled = false;
                } else {
                    console.error('Chart generation failed:', result.error);
                    alert('Failed to generate chart: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error generating chart:', error);
                alert('Failed to generate chart. Please try again.');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Chart';
            }
        }

        // --- DOWNLOAD CHART FUNCTION ---
        function downloadChart() {
            if (!currentChartUrl) {
                alert('No chart to download. Please generate a chart first.');
                return;
            }

            // Generate a descriptive filename
            const col1 = col1Select.value || 'chart';
            const col2 = col2Select.value;
            const chartType = chartTypeSelect.value || 'visualization';
            
            let filename = `datamuse_${col1}`;
            if (col2) {
                filename += `_vs_${col2}`;
            }
            filename += `_${chartType.toLowerCase().replace(/[^\w]/g, '_')}.png`;

            // Create a temporary link element and trigger download
            const link = document.createElement('a');
            link.href = currentChartUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        col1Select.addEventListener('change', updateSuggestions);
        col2Select.addEventListener('change', updateSuggestions);
        submitBtn.addEventListener('click', generateChart);
        downloadBtn.addEventListener('click', downloadChart);

        // Auto-generate chart when settings change (optional - uncomment if desired)
        // chartTypeSelect.addEventListener('change', () => {
        //     if (!submitBtn.disabled) generateChart();
        // });

        // --- INITIALIZATION ---
        // Check if there's an initial chart URL and enable download button if needed
        const initialChartUrlEl = document.getElementById('initial-chart-url');
        const initialChartUrl = initialChartUrlEl.dataset.url;
        if (initialChartUrl) {
            currentChartUrl = initialChartUrl;
            downloadBtn.disabled = false;
        }
        
        // --- INITIAL CALL ---
        updateSuggestions();

        // Add page load animations
        anime.timeline({loop: false})
            .add({
                targets: 'nav h1',
                translateY: [-30, 0],
                opacity: [0, 1],
                duration: 800,
                easing: 'easeOutExpo'
            })
            .add({
                targets: '.glass-card',
                translateY: [50, 0],
                opacity: [0, 1],
                duration: 1000,
                delay: anime.stagger(200),
                easing: 'easeOutExpo'
            }, '-=500')
            .add({
                targets: '.form-select',
                translateX: [-30, 0],
                opacity: [0, 1],
                duration: 600,
                delay: anime.stagger(100),
                easing: 'easeOutQuad'
            }, '-=300')
            .add({
                targets: '#submit-btn',
                scale: [0.9, 1],
                opacity: [0, 1],
                duration: 500,
                easing: 'easeOutBack'
            }, '-=200');
    </script>
</body>
</html>